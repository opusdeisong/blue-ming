import { NextRequest, NextResponse } from 'next/server'
import OpenAI from 'openai'

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
})

export async function POST(req: NextRequest) {
  try {
    const { type, formData } = await req.json()

    if (!type || !formData) {
      return NextResponse.json({ error: 'Type and formData are required' }, { status: 400 })
    }

    let prompt = ''
    let systemPrompt = ''

    switch (type) {
      case 'business-plan':
        systemPrompt = 'ë‹¹ì‹ ì€ ì¶˜ì²œì‹œ ì²­ë…„ ì°½ì—… ì§€ì›ì„ ìœ„í•œ ì‚¬ì—…ê³„íšì„œ ìž‘ì„± ì „ë¬¸ê°€ìž…ë‹ˆë‹¤. ì²´ê³„ì ì´ê³  ì‹¤ìš©ì ì¸ ì‚¬ì—…ê³„íšì„œë¥¼ ìž‘ì„±í•´ì£¼ì„¸ìš”.'
        prompt = `ë‹¤ìŒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì¶˜ì²œì‹œ ì²­ë…„ ì°½ì—…ì„ ìœ„í•œ ì‚¬ì—…ê³„íšì„œë¥¼ ìž‘ì„±í•´ì£¼ì„¸ìš”:

ì‚¬ì—…ëª…: ${formData.businessName || 'ë¯¸ìž…ë ¥'}
ì—…ì¢…: ${formData.businessType || 'ë¯¸ìž…ë ¥'}
ìœ„ì¹˜: ${formData.location || 'ë¯¸ìž…ë ¥'}
ì˜ˆì‚°: ${formData.budget || 'ë¯¸ìž…ë ¥'}
íƒ€ê²Ÿ ê³ ê°: ${formData.targetMarket || 'ë¯¸ìž…ë ¥'}

ë‹¤ìŒ êµ¬ì¡°ë¡œ ìž‘ì„±í•´ì£¼ì„¸ìš”:
1. ì‚¬ì—… ê°œìš”
2. ì‹œìž¥ ë¶„ì„ (ì¶˜ì²œì‹œ íŠ¹ì„± ë°˜ì˜)
3. íƒ€ê²Ÿ ê³ ê° ë¶„ì„
4. ë§ˆì¼€íŒ… ì „ëžµ
5. ìž¬ë¬´ ê³„íš
6. ë¦¬ìŠ¤í¬ ë¶„ì„
7. ì„±ê³µ ì „ëžµ`
        break

      case 'brand-generator':
        systemPrompt = 'ë‹¹ì‹ ì€ ì°½ì˜ì ì¸ ë¸Œëžœë“œëª… ìƒì„± ì „ë¬¸ê°€ìž…ë‹ˆë‹¤. ì¶˜ì²œ ì§€ì—­ íŠ¹ì„±ì„ ë°˜ì˜í•œ ê¸°ì–µí•˜ê¸° ì‰½ê³  ë§¤ë ¥ì ì¸ ë¸Œëžœë“œëª…ì„ ì œì•ˆí•´ì£¼ì„¸ìš”.'
        prompt = `ë‹¤ìŒ ì¡°ê±´ìœ¼ë¡œ ë¸Œëžœë“œëª…ì„ 5ê°œ ì œì•ˆí•´ì£¼ì„¸ìš”:

ì—…ì¢…: ${formData.businessType || 'ë¯¸ìž…ë ¥'}
ìœ„ì¹˜: ì¶˜ì²œì‹œ ${formData.location || ''}
ì»¨ì…‰: ì²­ë…„ ì°½ì—…, ì§€ì—­ ì¹œí™”ì 

ì¡°ê±´:
- ì¶˜ì²œì˜ ì§€ì—­ì  íŠ¹ì„± ë°˜ì˜ (ì†Œì–‘ê°•, ì˜ì•”í˜¸, ë‹­ê°ˆë¹„, ë§‰êµ­ìˆ˜ ë“±)
- ê¸°ì–µí•˜ê¸° ì‰½ê³  ë°œìŒí•˜ê¸° ì‰¬ìš´ ì´ë¦„
- ì Šì€ ì¸µì—ê²Œ ì–´í•„í•˜ëŠ” ëª¨ë˜í•œ ê°ì„±
- ê° ë¸Œëžœë“œëª…ì— ëŒ€í•œ ê°„ë‹¨í•œ ì„¤ëª… í¬í•¨`
        break

      case 'marketing':
        systemPrompt = 'ë‹¹ì‹ ì€ ì¶˜ì²œì‹œ ì§€ì—­ ë§ˆì¼€íŒ… ì „ë¬¸ê°€ìž…ë‹ˆë‹¤. ì²­ë…„ ì°½ì—…ìžë¥¼ ìœ„í•œ ì‹¤ìš©ì ì´ê³  ë¹„ìš© íš¨ìœ¨ì ì¸ ë§ˆì¼€íŒ… ì½˜í…ì¸ ë¥¼ ì œìž‘í•´ì£¼ì„¸ìš”.'
        prompt = `ë‹¤ìŒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ë§ˆì¼€íŒ… ì½˜í…ì¸ ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”:

ì‚¬ì—…ëª…: ${formData.businessName || 'ìš°ë¦¬ ë¸Œëžœë“œ'}
ì—…ì¢…: ${formData.businessType || 'ë¯¸ìž…ë ¥'}
ìœ„ì¹˜: ì¶˜ì²œì‹œ ${formData.location || ''}
íƒ€ê²Ÿ ê³ ê°: ${formData.targetMarket || 'ì¼ë°˜ ê³ ê°'}

ë‹¤ìŒì„ í¬í•¨í•´ì£¼ì„¸ìš”:
1. ì¸ìŠ¤íƒ€ê·¸ëž¨ ê²Œì‹œë¬¼ ì•„ì´ë””ì–´ (2-3ê°œ)
2. ë§ˆì¼€íŒ… ìŠ¬ë¡œê±´ (3-5ê°œ)
3. SNS í•´ì‹œíƒœê·¸ ì „ëžµ
4. ì§€ì—­ íŠ¹ìƒ‰ì„ í™œìš©í•œ ë§ˆì¼€íŒ… ì•„ì´ë””ì–´`
        break

      case 'prediction':
        systemPrompt = 'ë‹¹ì‹ ì€ ì°½ì—… ì„±ê³µë¥  ë¶„ì„ ì „ë¬¸ê°€ìž…ë‹ˆë‹¤. ë°ì´í„° ê¸°ë°˜ìœ¼ë¡œ ê°ê´€ì ì´ê³  êµ¬ì²´ì ì¸ ë¶„ì„ì„ ì œê³µí•´ì£¼ì„¸ìš”.'
        prompt = `ë‹¤ìŒ ì •ë³´ë¥¼ ë°”íƒ•ìœ¼ë¡œ ì°½ì—… ì„±ê³µ ì˜ˆì¸¡ ë¶„ì„ì„ í•´ì£¼ì„¸ìš”:

ì—…ì¢…: ${formData.businessType || 'ë¯¸ìž…ë ¥'}
ìœ„ì¹˜: ì¶˜ì²œì‹œ ${formData.location || ''}
ì˜ˆì‚°: ${formData.budget || 'ë¯¸ìž…ë ¥'}
íƒ€ê²Ÿ ê³ ê°: ${formData.targetMarket || 'ë¯¸ìž…ë ¥'}

ë‹¤ìŒì„ í¬í•¨í•´ì£¼ì„¸ìš”:
1. ì¢…í•© ì„±ê³µë¥  (60-90% ë²”ìœ„)
2. ë¶„ì„ ìš”ì†Œë³„ ì ìˆ˜ (ìœ„ì¹˜, ì—…ì¢… ì í•©ì„±, ìžê¸ˆ ê³„íš, ì‹œìž¥ ê²½ìŸë ¥)
3. ì£¼ìš” ë¦¬ìŠ¤í¬ ìš”ì¸ 3ê°€ì§€
4. ì„±ê³µë¥  í–¥ìƒ ë°©ì•ˆ 4ê°€ì§€
5. êµ¬ì²´ì ì¸ ê°œì„  ì œì•ˆ`
        break

      default:
        return NextResponse.json({ error: 'Invalid type' }, { status: 400 })
    }

    const completion = await openai.chat.completions.create({
      model: "gpt-4.1-mini",
      messages: [
        {
          role: "system",
          content: systemPrompt
        },
        {
          role: "user",
          content: prompt
        }
      ],
      max_tokens: 4096,
      temperature: 0.7,
    })

    const response = completion.choices[0]?.message?.content || 'ì£„ì†¡í•©ë‹ˆë‹¤. ì½˜í…ì¸ ë¥¼ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'

    return NextResponse.json({
      content: response,
      type: type
    })

  } catch (error) {
    console.error('OpenAI API Error:', error)
    
    // API í‚¤ê°€ ì—†ê±°ë‚˜ ì˜¤ë¥˜ê°€ ë°œìƒí•œ ê²½ìš° ì‹œë®¬ë ˆì´ì…˜ ì‘ë‹µ ë°˜í™˜
    const fallbackResponses = {
      'business-plan': `# ìƒˆë¡œìš´ ì°½ì—… ì‚¬ì—…ê³„íšì„œ

## 1. ì‚¬ì—… ê°œìš”
**ì‚¬ì—…ëª…**: ë¯¸ìž…ë ¥
**ì—…ì¢…**: ë¯¸ìž…ë ¥
**ìœ„ì¹˜**: ë¯¸ìž…ë ¥
**ì˜ˆìƒ íˆ¬ìžê¸ˆ**: ë¯¸ìž…ë ¥

## 2. ì‹œìž¥ ë¶„ì„
ì¶˜ì²œì‹œì—ì„œ ì„ íƒëœ ì—…ì¢…ì€ ì•ˆì •ì ì¸ ìˆ˜ìš”ê°€ ì˜ˆìƒë©ë‹ˆë‹¤.

## 3. íƒ€ê²Ÿ ê³ ê°
ì£¼ìš” íƒ€ê²Ÿ: ì¼ë°˜ ê³ ê°

## 4. ë§ˆì¼€íŒ… ì „ëžµ
- SNS ë§ˆì¼€íŒ… í™œìš©
- ì§€ì—­ íŠ¹ìƒ‰ ë°˜ì˜í•œ ì„œë¹„ìŠ¤ ê°œë°œ

## 5. ìž¬ë¬´ ê³„íš
**ì´ˆê¸° íˆ¬ìžë¹„**: ë¯¸ìž…ë ¥
**ì˜ˆìƒ ì†ìµë¶„ê¸°ì **: ì°½ì—… í›„ 8-12ê°œì›”`,

      'brand-generator': `# ì°½ì—… ë¸Œëžœë“œëª… ì¶”ì²œ

## ì¶”ì²œ ë¸Œëžœë“œëª…:
1. **ì¶˜ì²œì˜ ë§›**
2. **ì†Œì–‘ê°• ì¹´íŽ˜**
3. **ë¸”ë£¨ë° ìŠ¤í† ì–´**
4. **í˜¸ìˆ˜ê°€ ë¸Œëžœë“œ**

## ë¸Œëžœë“œ ì»¨ì…‰:
- ì¶˜ì²œ ì§€ì—­ì„± ë°˜ì˜
- ì²­ë…„ ì¹œí™”ì  ë„¤ì´ë°
- ê¸°ì–µí•˜ê¸° ì‰¬ìš´ ì´ë¦„`,

      'marketing': `# ìš°ë¦¬ ë¸Œëžœë“œ ë§ˆì¼€íŒ… ì½˜í…ì¸ 

## ì¸ìŠ¤íƒ€ê·¸ëž¨ ê²Œì‹œë¬¼:
1. "ì¶˜ì²œì— ìƒˆë¡œìš´ ì°½ì—…ì´ ì˜¤í”ˆí–ˆì–´ìš”! ðŸŽ‰"
2. "ì§€ì—­ íŠ¹ì‚°í’ˆì„ í™œìš©í•œ íŠ¹ë³„í•œ ë©”ë‰´ ì†Œê°œ"

## ë§ˆì¼€íŒ… ìŠ¬ë¡œê±´:
- "ì¶˜ì²œì—ì„œ ì‹œìž‘ëœ ì²­ë…„ì˜ ê¿ˆ"
- "ì†Œì–‘ê°•ì²˜ëŸ¼ ìžì—°ìŠ¤ëŸ½ê²Œ"

## SNS í•´ì‹œíƒœê·¸:
#ì¶˜ì²œ #ì²­ë…„ì°½ì—… #ì‹ ê·œì˜¤í”ˆ`,

      'prediction': `# ì°½ì—… ì„±ê³µ ì˜ˆì¸¡ ë¶„ì„

## ì¢…í•© ì„±ê³µë¥ : 75%

### ë¶„ì„ ìš”ì†Œë³„ ì ìˆ˜:
- **ìœ„ì¹˜ ë¶„ì„**: 85ì 
- **ì—…ì¢… ì í•©ì„±**: 80ì   
- **ìžê¸ˆ ê³„íš**: 75ì 
- **ì‹œìž¥ ê²½ìŸë ¥**: 70ì 

### ì£¼ìš” ë¦¬ìŠ¤í¬:
1. ê³„ì ˆì  ë§¤ì¶œ ë³€ë™
2. ìž„ëŒ€ë£Œ ìƒìŠ¹ ìœ„í—˜
3. ê²½ìŸ ì—…ì²´ ì¦ê°€

### ì„±ê³µë¥  í–¥ìƒ ë°©ì•ˆ:
1. ì§€ì—­ íŠ¹í™” ì„œë¹„ìŠ¤ ê°œë°œ
2. SNS ë§ˆì¼€íŒ… ê°•í™”
3. ê³ ê° ì„œë¹„ìŠ¤ ì°¨ë³„í™”
4. ì¶˜ì²œì‹œ ì§€ì› ì •ì±… í™œìš©`
    }

    // ìš”ì²­ ë³¸ë¬¸ì„ ë‹¤ì‹œ íŒŒì‹±í•˜ì—¬ type ì–»ê¸°
    const requestBody = await req.json().catch(() => ({ type: 'business-plan' }))
    const requestType = requestBody.type || 'business-plan'

    return NextResponse.json({
      content: fallbackResponses[requestType as keyof typeof fallbackResponses] || fallbackResponses['business-plan'],
      type: requestType,
      isSimulation: true
    })
  }
} 